{% extends 'base.html' %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-auto text-center mx-auto">
            {% if data.get("accession") and data.get("accession") != "MITE9999999" %}
            <h1 class="fw-semibold lh-2">Modify {{ data.accession }}</h1>
            {% else %}
            <h1 class="fw-semibold lh-2">Create New Entry</h1>
            {% endif %}
            <h5>Submission ID: {{ var }}</h5>
        </div>
    </div>
    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div class="mx-4 my-2">
      <div class="alert alert-light" role="alert">
        <div class="row">
          <div class="col-8">
            <h5 class="mb-0"> Error during validation!</h5>
          </div>
          <div class="col-4">
            <button type="button" class="btn-close float-end" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        </div>
          <div class="row my-4">
          <div class="text-center mx-auto">
            {% for message in messages %}
            <textarea readonly class="form-control" rows="5">{{ message }}</textarea>
            {% endfor %}
          </div>
          </div>
          <div class="row">
          <div class="text-center mx-auto">
            <h6>If you have issues with compound aromaticity, try to <a class="custom-link" target="_blank" href="{{ url_for('routes.canonsmiles') }}">canonicalize your substrate/product SMILES</a>.</h6>
            <h6>For more troubleshooting tips, see the <a class="custom-link" target="_blank" href="{{ url_for('routes.troubleshooting') }}">troubleshooting page</a>.</h6>
          </div>
          </div>
      </div>
    </div>

    {% endif %}
    {% endwith %}
    <div class="row my-4">
        <div class="col text-center mx-auto">
            <h6>For help on how to create MITE entries, check out the <a rel="MITE video tutorial on YouTube" href="https://www.youtube.com/watch?v=xw8Xig8uq90" class="custom-link" target="_blank"><b>video tutorial</b></a> or the <a class="custom-link" href="{{ url_for('routes.tutorial') }}"><b>Tutorial page</b></a>.</h6>
            <h6>See also our handy <a rel="MITE Peptide SMILES Drawer" href="{{ url_for('routes.peptidesmiles') }}" class="custom-link" target="_blank"><b>peptide SMILES generator</b></a> and <a class="custom-link" target="_blank" href="{{ url_for('routes.canonsmiles') }}"><b>SMILES canonicalizer</b></a> tool.</h6>
            <p><i><span class="mandatory">*</span>mandatory; <span class="mandatory">**</span>conditionally mandatory</i></p>
        </div>
    </div>
    <form method="post" action="{{ url_for('routes.submission_process', var=var) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="mite_accession" value="{{ data.get('accession', '') }}">
        <div class="row my-2" id="row-enzyme">
            <div class="col-md-6" id="col-enzyme">
                <div class="row">
                    <div class="col">
                        <h2 class="fw-semibold lh-2 text-center">Enzyme Information</h2>
                        <p class="mb-2 text-center">General information on the tailoring enzyme</p>
                    </div>
                </div>
                <div class="row m-2 g-2">
                    <div class="col">
                        <div id="enzyme-name"></div>
                    </div>
                    <div class="col">
                        <div id="enzyme-description"></div>
                    </div>
                </div>
                <div class="row m-2 g-2">
                    <div class="col">
                        <div id="comment-general"></div>
                    </div>
                </div>
                <div class="row m-2 g-2">
                    <div class="col">
                        <div id="enzyme-uniprot"></div>
                    </div>
                    <div class="col">
                        <div id="enzyme-genpept"></div>
                    </div>
                    <div class="col">
                        <div id="enzyme-mibig"></div>
                    </div>
                    <div class="col">
                        <div id="enzyme-wikidata"></div>
                    </div>
                </div>
                <div class="row m-2 g-2">
                    <div class="col">
                        <div id="enzyme-cofactors"></div>
                    </div>
                </div>
                <div class="row m-2 g-2">
                    <div class="col">
                        <div id="enzyme-ref"></div>
                        <button type="button" class="btn btn-secondary my-2" onclick="insertEnzymeRefForm(document.getElementById('enzyme-ref'))">Add Reference</button>
                    </div>
                </div>
            </div>
            <div class="col-md-6" id="col-auxenzyme">
                <div class="row">
                    <div class="col">
                        <h2 class="fw-semibold lh-2 text-center">Auxiliary Enzymes</h2>
                        <p class="mb-2 text-center">Enzymes required for the function of the tailoring enzyme in question</p>
                    </div>
                </div>
                <div class="card card-body">
                    <div class="row">
                        <div class="col">
                            <div id="aux-enzymes"></div>
                            <button type="button" class="btn btn-secondary my-2" onclick="insertAuxEnzymeForm(document.getElementById('aux-enzymes'))">Add Auxiliary Enzyme</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row my-2" id="row-reaction">
            <div class="row my-2">
                <div class="col">
                    <h2 class="fw-semibold lh-2 text-center">Reaction Information</h2>
                    <p class="mb-2 text-center">Reaction information for this tailoring enzyme</p>
                </div>
            </div>
            <div class="card card-body">
                <div class="row mb-2">
                    <div class="col">
                        <h5 class="fw-semibold lh-2">Reaction Entries</h5>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col">
                        <div id="reactions"></div>
                        <button type="button" class="btn btn-secondary my-2" id="add-reaction-btn">Add Reaction</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="row my-3">
            <div class="col">
                <h3 class="fw-semibold lh-2 text-center">General Information</h3>
                <p class="mb-2 text-center">Submitter details and other information</p>
            </div>
        </div>
        <div class="card card-body mb-2">
            <div class="row m-2 g-2">
                <div class="col">
                    <div class="form-floating">
                        <input id="orcid" minlength="19" maxlength="19" name="orcid" class="form-control" placeholder="n/a" type="text" title="Enter your ORCID or leave empty for an anonymous submission. If you enter your ORCID, be aware that it will be made visible on our website, as described in our Terms of Use.">
                        <label for="orcid" class="form-label">ORCID <i class="bi bi-question-circle"></i></label>
                    </div>
                </div>
                <div class="col">
                    <div class="form-floating">
                        <input id="changelog" name="changelog" class="form-control" placeholder="n/a" type="text" required title="Briefly describe your changes. If you submit a new entry, simply state 'New entry'">
                        <label for="changelog" class="form-label">Changelog <span class="mandatory">*</span> <i class="bi bi-question-circle"></i></label>
                    </div>
                </div>
            </div>
            <div class="row m-2 g-2">
                <div class="col">
                    <h6 class="fw-semibold lh-2">Math Challenge<span class="mandatory">*</span></h6>
                    <div class="form-floating">
                        <input id="usersum" name="usersum" class="form-control" placeholder="n/a" type="number" required title="Validation form to prevent automated submissions">
                        <label for="usersum" class="form-label">What is the sum of <b>{{ x }}</b> and <b>{{ y }}</b>?<span class="mandatory">*</span> <i class="bi bi-question-circle"></i></label>
                    </div>
                    <p class="lead" id="usersum-error-message" style="color: red;"></p>
                </div>
                <div class="col">
                    <h6 class="fw-semibold lh-2">Terms of Use<span class="mandatory">*</span></h6>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="True" id="terms-of-use-check" name="terms-of-use-check" required>
                      <label class="form-check-label" for="terms-of-use-check">I have read and approve of the <a target="_blank" class="custom-link" href="{{ url_for('routes.termsofuse') }}">Terms of Use</a>. If I have provided an ORCID, I explicitly agree that it is displayed in association with the submitted data.</label>
                    </div>
                </div>
            </div>
        </div>
        <div class="row my-3">
            <div class="col text-center mx-auto">
                <button id="submit" type="submit" class="btn btn-primary">Preview entry</button>
            </div>
        </div>
    </form>
</div>
<script>const url_submission = {{ url_for('routes.submission') }}</script>
<script type="text/javascript" src="{{ url_for('static', filename='js/submission.js') }}" defer></script>
<script>
    document.querySelector('form').addEventListener('submit', function(event) {
        validateSumInput(event, {{ x }}, {{ y }});
    });

    const formVals = {{ form_vals | tojson | safe }};
    document.getElementById('add-reaction-btn').addEventListener('click', () => {
        const container = document.getElementById('reactions');
        insertReactionForm(container, formVals);
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const data = {{ data | tojson | safe }};
        const formVals = {{ form_vals | tojson | safe }};
    
        createHtmlEnzymeName(document.getElementById('enzyme-name'), data)
        createHtmlEnzymeDescription(document.getElementById('enzyme-description'), data)
        createGeneralComment(document.getElementById('comment-general'), data)
        createHtmlEnzymeUniprot(document.getElementById('enzyme-uniprot'), data)
        createHtmlEnzymeGenpept(document.getElementById('enzyme-genpept'), data)
        createHtmlEnzymeMibig(document.getElementById('enzyme-mibig'), data)
        createHtmlEnzymeWikidata(document.getElementById('enzyme-wikidata'), data)
        createHtmlEnzymeCofactors(document.getElementById('enzyme-cofactors'), data, formVals)
        populateEnzymeRefForm(document.getElementById('enzyme-ref'), data)
        populateAuxEnzymeForm(document.getElementById('aux-enzymes'), data)
        populateReactionForm(document.getElementById('reactions'), data, formVals)
        testFirefoxMobile()
    });
</script>
{% endblock %}